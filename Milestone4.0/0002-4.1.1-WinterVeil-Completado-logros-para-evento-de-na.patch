From 7ab871e005aa9bb30cdce26aa054a87497443d42 Mon Sep 17 00:00:00 2001
From: Eilo <eilo2518@gmail.com>
Date: Fri, 30 Dec 2011 18:05:18 -0500
Subject: [PATCH 2/2] 4.1.1 WinterVeil: Completado logros para evento de
 navidad

---
 .../reanemu/2011_12_20_100_world_winter_veil.sql   |   23 ++++++++++++++++++++
 src/server/game/Achievements/AchievementMgr.cpp    |    3 +-
 src/server/game/Entities/Unit/Unit.cpp             |    4 +-
 3 files changed, 26 insertions(+), 4 deletions(-)
 create mode 100644 sql/updates/world/reanemu/2011_12_20_100_world_winter_veil.sql

diff --git a/sql/updates/world/reanemu/2011_12_20_100_world_winter_veil.sql b/sql/updates/world/reanemu/2011_12_20_100_world_winter_veil.sql
new file mode 100644
index 0000000..6c83174
--- /dev/null
+++ b/sql/updates/world/reanemu/2011_12_20_100_world_winter_veil.sql
@@ -0,0 +1,23 @@
+-- WinterVeil
+-- [WinterVeil] Bros. Before Ho-Ho-Ho`s
+UPDATE `creature_template` SET `unit_flags`=`unit_flags`&~0x100, `type_flags`=`type_flags`|0x4000000 WHERE `entry` IN (739,927,1182,1351,1444,5484,5489,5661,8140,12336,26044);
+UPDATE `creature` SET `spawntimesecs`=20 WHERE `id` IN (739,927,1182,1351,1444,5484,5489,5661,8140,12336,26044);
+UPDATE `item_template` SET `Flags`=0x40 WHERE `entry`=21519;
+-- Magni Bronzebeard
+UPDATE `creature_template` SET `unit_flags`=`unit_flags`&~2,`AIName`='',`ScriptName`='boss_king_magni_bronzebeard' WHERE `entry`=2784;
+DELETE FROM `creature_text` WHERE `entry`=2784;
+INSERT INTO `creature_text` (`entry`,`groupid`,`id`,`text`,`type`,`language`,`probability`,`emote`,`duration`,`sound`,`comment`) VALUES
+(2784,1,0,'For Khaz''Modan!',14,0,0,5,0,5896,'Magni Bronzebeard - Aggro'),
+(2784,1,1,'Feel the fury of the mountain!',14,0,0,5,0,5896,'Magni Bronzebeard - Aggro');
+-- Ironforge Guard
+UPDATE `creature_template` SET `AIName`='SmartAI',`ScriptName`='' WHERE `entry`=5595;
+DELETE FROM `smart_scripts` WHERE `source_type`=0 AND `entryorguid`=5595;
+INSERT INTO `smart_scripts` (`entryorguid`,`source_type`,`id`,`link`,`event_type`,`event_phase_mask`,`event_chance`,`event_flags`,`event_param1`,`event_param2`,`event_param3`,`event_param4`,`action_type`,`action_param1`,`action_param2`,`action_param3`,`action_param4`,`action_param5`,`action_param6`,`target_type`,`target_param1`,`target_param2`,`target_param3`,`target_x`,`target_y`,`target_z`,`target_o`,`comment`) VALUES
+(5595,0,0,0,54,0,100,0,0,0,0,0,49,0,0,0,0,0,0,21,75,0,0,0,0,0,0,'Ironforge Guard - On Summon - Start Attack'),
+(5595,0,1,0,0,0,100,0,5000,5000,5000,5000,49,0,0,0,0,0,0,5,0,0,0,0,0,0,0,'Ironforge Guard - every 5 sec  - change Target'),
+(5595,0,2,0,0,0,100,0,5000,7000,8000,10000,11,11971,0,0,0,0,0,2,0,0,0,0,0,0,0,'Ironforge Guard - IC - cast Sunder Armor'),
+(5595,0,3,0,0,0,100,0,5000,7000,10000,12000,11,8078,0,0,0,0,0,2,0,0,0,0,0,0,0,'Ironforge Guard - IC - cast Thunderclap');
+UPDATE `quest_template` SET `RequiredRaces`=690,`RewardMailTemplateId`=108,`RewardMailDelay`=86400,`RewardFactionid1`=169,`RewardFactionValueId1`=3 WHERE `id`=6963;
+DELETE FROM `mail_loot_template` WHERE `entry`=108;
+INSERT INTO `mail_loot_template` (`entry`,`item`,`ChanceOrQuestChance`,`lootmode`,`groupid`,`mincountOrRef`,`maxcount`) VALUES
+(108,17712,100,1,0,1,1);
diff --git a/src/server/game/Achievements/AchievementMgr.cpp b/src/server/game/Achievements/AchievementMgr.cpp
index b4a8260..0b54ae1 100755
--- a/src/server/game/Achievements/AchievementMgr.cpp
+++ b/src/server/game/Achievements/AchievementMgr.cpp
@@ -699,7 +699,7 @@ void AchievementMgr::SendCriteriaUpdate(AchievementCriteriaEntry const* entry, C
     if (!entry->timeLimit)
         data << uint32(0);
     else
-        data << uint32(timedCompleted ? 0 : 1); // this are some flags, 1 is for keeping the counter at 0 in client
+        data << uint32(timedCompleted ? 1 : 0); // this are some flags, 1 is for keeping the counter at 0 in client
     data << uint32(secsToTimeBitFields(progress->date));
     data << uint32(timeElapsed);    // time elapsed in seconds
     data << uint32(0);              // unk
@@ -1075,7 +1075,6 @@ void AchievementMgr::UpdateAchievementCriteria(AchievementCriteriaTypes type, ui
                     AchievementCriteriaDataSet const* data = sAchievementMgr->GetCriteriaDataSet(achievementCriteria);
                     if (!data || !data->Meets(GetPlayer(), unit))
                         continue;
-                    break;
                 }
 
                 SetCriteriaProgress(achievementCriteria, 1);
diff --git a/src/server/game/Entities/Unit/Unit.cpp b/src/server/game/Entities/Unit/Unit.cpp
index f2bd657..5b448ee 100755
--- a/src/server/game/Entities/Unit/Unit.cpp
+++ b/src/server/game/Entities/Unit/Unit.cpp
@@ -12354,8 +12354,8 @@ bool Unit::_IsValidAssistTarget(Unit const* target, SpellInfo const* bySpell) co
     }
 
     // can't assist non-friendly targets
-    if (GetReactionTo(target) <= REP_NEUTRAL
-        && target->GetReactionTo(this) <= REP_NEUTRAL
+    if (GetReactionTo(target) < REP_NEUTRAL
+        && target->GetReactionTo(this) < REP_NEUTRAL
         && (!ToCreature() || !(ToCreature()->GetCreatureInfo()->type_flags & CREATURE_TYPEFLAGS_UNK26)))
         return false;
 
-- 
1.7.6.msysgit.0

