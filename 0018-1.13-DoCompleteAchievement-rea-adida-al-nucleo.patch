From b172800eed90bb3983f9c980b654522770b00dac Mon Sep 17 00:00:00 2001
From: Eilo <eilo2518@gmail.com>
Date: Thu, 15 Dec 2011 22:08:54 -0500
Subject: [PATCH 18/22] =?UTF-8?q?1.13=20DoCompleteAchievement=20rea=C3=B1adi?=
 =?UTF-8?q?da=20al=20nucleo?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 WHAT_IS_INSIDE                               |    1 +
 src/server/game/Instances/InstanceScript.cpp |   18 ++++++++++++++++++
 src/server/game/Instances/InstanceScript.h   |    3 +++
 3 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/WHAT_IS_INSIDE b/WHAT_IS_INSIDE
index 336dc27..44c08d3 100644
--- a/WHAT_IS_INSIDE
+++ b/WHAT_IS_INSIDE
@@ -41,6 +41,7 @@ Milestone1.0: Mejoras en general, aplicacion de planificacion y adicion de codig
 09/10/2011: Desactivado avisos Join/Leave en canales por Odyssey
 05/10/2011: Permitiendo unirse al canal LFG sin estar en ciudad principal por Opcode187
 07/10/2011: DynamicLoS en GameObjects por Odyssey
+01/11/2011: DoCompleteAchievement reañadida al nucleo como funcion activa por Eilo
 
 
 ###############
diff --git a/src/server/game/Instances/InstanceScript.cpp b/src/server/game/Instances/InstanceScript.cpp
index b8987be..5efc153 100755
--- a/src/server/game/Instances/InstanceScript.cpp
+++ b/src/server/game/Instances/InstanceScript.cpp
@@ -320,6 +320,24 @@ void InstanceScript::DoSendNotifyToInstance(const char *format, ...)
     }
 }
 
+// Complete Achievement for all players in instance
+void InstanceScript::DoCompleteAchievement(uint32 achievement)
+{
+    AchievementEntry const* pAE = GetAchievementStore()->LookupEntry(achievement);
+    Map::PlayerList const &PlayerList = instance->GetPlayers();
+
+    if (!pAE)
+    {
+        sLog->outError("TSCR: DoCompleteAchievement called for not existing achievement %u", achievement);
+        return;
+    }
+
+    if (!PlayerList.isEmpty())
+        for (Map::PlayerList::const_iterator i = PlayerList.begin(); i != PlayerList.end(); ++i)
+            if (Player *player = i->getSource())
+                player->CompletedAchievement(pAE);
+}
+
 // Update Achievement Criteria for all players in instance
 void InstanceScript::DoUpdateAchievementCriteria(AchievementCriteriaTypes type, uint32 miscValue1 /*= 0*/, uint32 miscValue2 /*= 0*/, Unit* unit /*= NULL*/)
 {
diff --git a/src/server/game/Instances/InstanceScript.h b/src/server/game/Instances/InstanceScript.h
index 1751b7b..2884054 100755
--- a/src/server/game/Instances/InstanceScript.h
+++ b/src/server/game/Instances/InstanceScript.h
@@ -169,6 +169,9 @@ class InstanceScript : public ZoneScript
         // Send Notify to all players in instance
         void DoSendNotifyToInstance(char const* format, ...);
 
+        // Complete Achievement for all players in instance
+        void DoCompleteAchievement(uint32 achievement);
+
         // Update Achievement Criteria for all players in instance
         void DoUpdateAchievementCriteria(AchievementCriteriaTypes type, uint32 miscValue1 = 0, uint32 miscValue2 = 0, Unit* unit = NULL);
 
-- 
1.7.6.msysgit.0

